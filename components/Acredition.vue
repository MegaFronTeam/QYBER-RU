<template>
  <div v-if="!globalStore.userData.user_verification">
    <Message severity="warn" :closable="false">
      <div v-if="globalStore.in_verifications">Заявка на аккредитацию на рассмотрении</div>
      <template v-else>
        <div style="margin-block: 0.3rem">
          Для того чтобы пользоваться сервисом и участвовать в турнирах вам необходимо пройти
          аккредитацию.
        </div>

        <Button
          class="ms-auto btn-sm p-button-outlined"
          outlined=""
          @click="
            visibleShow = true;
            globalStore.in_verifications = false;
          "
          label="Аккредитация"
        />
      </template>
    </Message>

    <Dialog
      v-if="!globalStore.in_verifications"
      v-model:visible="visibleShow"
      modal
      :header="!globalStore.in_verifications ? 'Аккредитация' : 'На проверке'"
    >
      <div class="form-wrap">
        <form
          @submit.prevent="userStore.sendVerification({ inn, leagues, file, selectedWorkStudy })"
          v-if="!globalStore.in_verifications"
        >
          <InputGroup>
            <label for="inn">ИНН компании/учебного заведения</label>
            <InputText id="inn" type="text" v-model="inn" placeholder="Введите ИНН " />
          </InputGroup>

          <InputGroup>
            <label for="name">Вы работаете или учитесь</label>
            <Dropdown
              v-model="selectedWorkStudy"
              :options="cities"
              optionLabel="name"
              placeholder="Выбрать"
              class="w-full"
            />
          </InputGroup>

          <InputGroup class="select-team">
            <label for="leagues">Лига</label>
            <SelectButton
              id="leagues"
              v-model="leagues"
              optionValue="slug"
              optionLabel="name"
              :options="globalStore.leaguesOptions"
              aria-labelledby="basic"
              :allowEmpty="false"
            />
          </InputGroup>

          <InputGroup>
            <label for="textarea">Загрузите документ</label>
            <div>
              <FileUpload
                mode="basic"
                name="file"
                id="file"
                accept="image/*"
                maxFileSize="5000000"
                url="/api/upload"
                @select="customBase64Uploader"
                chooseLabel="Загрузить документ"
              >
              </FileUpload>

              <br />
              <p class="text-center">Максимальный вес 5 мб.</p>
              <small
                >Для учащихся необходимо прикрепить справку с места учёбы, либо студенческий билет.
                Для работающих игроков необходимо прикрепить справку с места работы</small
              >
            </div>
          </InputGroup>
          <Button type="submit" class="btn-lg">Отправить</Button>
        </form>
        <div v-else>
          <p>Мы проверим вашу заявку в ближайшее время</p>
          <Button @click="visibleShow = false" label="Закрыть" />
        </div>
      </div>
    </Dialog>
  </div>
</template>

<script setup>
  import { useUserStore } from '@/store/userStore';
  import { useGlobalStore } from '@/store/globalStore';
  const userStore = useUserStore();
  const globalStore = useGlobalStore();

  // import Auth from '@/services/auth';
  // import Team from '@/services/team';

  // const { $locally } = useNuxtApp();

  const visibleShow = ref(false);

  const UserVerificationSend = ref(false);

  const inn = ref('');
  const leagues = ref([]);
  const file = ref({});
  const selectedWorkStudy = ref(null);

  const customBase64Uploader = async (event) => {
    file.value = event.files[0];
    // console.log(fileAcred);
    // file.value = event.files[0];

    const reader = new FileReader();
    let blob = await fetch(file.value.objectURL).then((r) => r.blob()); //blob:url

    reader.readAsDataURL(blob);

    reader.onloadend = function () {
      const base64data = reader.result;
    };
  };

  const cities = ref([
    { name: 'Учусь', value: 'study' },
    { name: 'Работаю', value: 'work' },
    { name: 'Учусь и работаю ', value: 'work_study' },
  ]);
</script>

<style lang="scss" scoped>
  /* Your component's styles here */
</style>
